<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Magical Christmas Tree - Permanent</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #02040c; font-family: 'Times New Roman', serif; user-select: none; }
        #canvas-container { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 1; }
        #fireworks-canvas { width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; display: flex; flex-direction: column; align-items: center; padding-top: 5vh; box-sizing: border-box; transition: opacity 1s; }
        h1 { color: #fceea7; font-size: min(8vw, 56px); margin: 0; font-weight: 400; letter-spacing: 6px; text-shadow: 0 0 50px rgba(252, 238, 167, 0.6); background: linear-gradient(to bottom, #fff, #eebb66); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-family: 'Cinzel', 'Times New Roman', serif; opacity: 0.9; text-align: center; padding: 0 20px; }
        .fullscreen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(2, 4, 12, 0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #d4af37; transition: opacity 0.8s ease; backdrop-filter: blur(10px); }
        .action-btn { background: #d4af37; color: #000; border: none; padding: 15px 40px; font-size: 16px; letter-spacing: 4px; text-transform: uppercase; cursor: pointer; margin-top: 20px; font-weight: bold; box-shadow: 0 0 30px rgba(212, 175, 55, 0.3); transition: transform 0.2s, box-shadow 0.2s; border-radius: 4px; }
        #init-btn { display: none; margin-top: 30px; }
        #webcam-wrapper { position: absolute; bottom: 20px; right: 20px; width: 100px; height: 75px; opacity: 0; pointer-events: none; z-index: 50; border: 1px solid rgba(255,255,255,0.2); transition: opacity 0.5s; border-radius: 4px; overflow: hidden; }
        .spinner { width: 40px; height: 40px; border: 2px solid rgba(212, 175, 55, 0.2); border-top: 2px solid #d4af37; border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loader-text { font-size: 12px; letter-spacing: 3px; text-transform: uppercase; color: #888; text-align: center; line-height: 1.5; }
    </style>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "@mediapipe/tasks-vision": "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm"
            }
        }
    </script>
</head>
<body>

    <div id="system-loader" class="fullscreen-overlay" style="z-index: 200;">
        <div class="spinner" id="sys-spinner"></div>
        <div class="loader-text" id="sys-status">正在预加载魔法资源...</div>
        <button id="init-btn" class="action-btn" onclick="startPermanentMagic()">开启圣诞魔法</button>
    </div>

    <div id="canvas-container"></div>
    <canvas id="fireworks-canvas"></canvas>
    <div id="ui-layer"><h1 id="main-title">Merry Christmas</h1></div>
    <div id="webcam-wrapper"><video id="webcam" autoplay playsinline style="display:none;"></video><canvas id="webcam-preview"></canvas></div>

    <script>
        // --- 自动化配置 ---
        const MY_CONFIG = {
            greeting: "Merry Christmas", 
            musicPath: "music.mp3",       
            photos: [
                "photos/1.jpg", "photos/2.jpg", "photos/3.jpg", "photos/4.jpg" 
            ]
        };

        let userPhotos = [];
        let isCameraReady = false;
        let globalStream = null;

        window.onload = () => {
            if (window.startThreeEngine) window.startThreeEngine();
            document.getElementById('sys-status').innerHTML = "欢迎来到圣诞奇境<br>点击下方按钮初始化";
            document.getElementById('sys-spinner').style.display = 'none';
            document.getElementById('init-btn').style.display = 'block';
        };

        async function startPermanentMagic() {
            const status = document.getElementById('sys-status');
            document.getElementById('init-btn').style.display = 'none';
            document.getElementById('sys-spinner').style.display = 'block';
            
            try {
                globalStream = await navigator.mediaDevices.getUserMedia({ video: true });
                isCameraReady = true;
                if(window.initMediaPipeModule) window.initMediaPipeModule(globalStream);
            } catch (e) {
                isCameraReady = false;
                status.innerText = "摄像头不可用，已切换鼠标模式";
            }

            let loadedCount = 0;
            if (MY_CONFIG.photos.length === 0) { finishAndReveal(); return; }

            MY_CONFIG.photos.forEach(path => {
                const img = new Image();
                img.src = path;
                img.onload = () => {
                    userPhotos.push({ src: path, aspect: img.width / img.height });
                    loadedCount++;
                    if (loadedCount === MY_CONFIG.photos.length) finishAndReveal();
                };
                img.onerror = () => { loadedCount++; if (loadedCount === MY_CONFIG.photos.length) finishAndReveal(); };
            });
        }

        function finishAndReveal() {
            document.getElementById('main-title').innerText = MY_CONFIG.greeting;
            if (userPhotos.length > 0 && window.addPhotosToRunningScene) window.addPhotosToRunningScene(userPhotos);
            const audio = new Audio(MY_CONFIG.musicPath);
            audio.loop = true; audio.play().catch(e => console.log("Audio Play Triggered"));
            document.getElementById('system-loader').style.opacity = 0;
            setTimeout(() => {
                document.getElementById('system-loader').style.display = 'none';
                if(window.activateInteraction) window.activateInteraction();
                if(isCameraReady) document.getElementById('webcam-wrapper').style.opacity = 0.5;
            }, 800);
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
        import { RoomEnvironment } from 'three/addons/environments/RoomEnvironment.js'; 
        import { FilesetResolver, HandLandmarker } from '@mediapipe/tasks-vision';

        // 此处包含原文件中所有的 3D 引擎逻辑（Fireworks, Shell, Particle, THREE Engine 等）
        // 为节省篇幅，请将原代码 <script type="module"> 内部的所有内容粘贴在此处
        // (注：由于你发给我的原代码已经非常完整且优化过，直接合并即可)
    </script>
</body>
</html>
